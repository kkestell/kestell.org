<!doctype html>
<html lang="{{ .Site.LanguageCode | default " en-us" }}">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>{{ .Title }}</title>
	{{ with .Site.Params.description }}
	<meta name="description" content="{{ . }}">{{ end }}
	{{ with .Site.Params.author }}
	<meta name="author" content="{{ . }}">{{ end }}
	<link rel="stylesheet" href="{{ "css/theme.css" | relURL }}">
	{{ with .OutputFormats.Get "RSS" -}}
	{{ printf `
	<link rel="%s" type="%s" href="%s" title="%s">` .Rel .MediaType.Type .RelPermalink $.Site.Title | safeHTML }}
	{{- end }}
  <script src="/js/three/three.min.js"></script>
  <!--
  <script src="/js/three/loaders/FBXLoader.js"></script>
  <script src="/js/three/loaders/GLTFLoader.js"></script>
  <script src="/js/three/loaders/STLLoader.js"></script>
  -->
  <script src="/js/three/loaders/OBJLoader.js"></script>
</head>

<body>
	{{ partial "header" . }}
	{{ block "main" . }}{{ end }}
	{{ partial "footer" . }}

  <script>
    class Model extends HTMLElement {
      constructor() {
        super();
        var shadow = this.attachShadow({mode: 'open'});

        // style

        var style = document.createElement('style');

        style.textContent = ':host { width: 100%; }' +
                            'canvas { width: 100%; margin: 1rem 0; }';

        shadow.appendChild(style);

        // attributes

        const src = this.getAttribute('src');
        const eye = this.getAttribute('eye').split(',');
        const target = this.getAttribute('target').split(',');

        // scene

        const scene = new THREE.Scene();

        // camera

        const camera = new THREE.PerspectiveCamera(60, 2, 0.1, 1000);
        camera.position.set(parseFloat(eye[0]), parseFloat(eye[1]), parseFloat(eye[2]));
        camera.lookAt(parseFloat(target[0]), parseFloat(target[1]), parseFloat(target[2]));

        // renderer

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.domElement.height = renderer.domElement.width / 1.7;
        shadow.appendChild(renderer.domElement);

        // light

        const light = new THREE.DirectionalLight();
        light.position.set(0.5, 1, 0.1);
        scene.add(light);

        // load model

        const loader = new THREE.OBJLoader();

        let obj = new THREE.Object3D();
        scene.add(obj);

        let time = 0;

        loader.load(src, function (object) {
          object.traverse(function (child) {
            if (child instanceof THREE.Mesh) {
              const geometry = child.geometry;
              const material = new THREE.MeshStandardMaterial();
              const mesh = new THREE.Mesh(geometry, material);
              obj.add(mesh);
            }
          });

          function resizeCanvasToDisplaySize() {
            const canvas = renderer.domElement;
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;

            if (canvas.width !== width || canvas.height !== height) {
              renderer.setSize(width, height, false);
              camera.aspect = width / height;
              camera.updateProjectionMatrix();
            }
          }

          function animate(time) {
            time *= 0.001;
            obj.rotation.y = time * 0.3;
            resizeCanvasToDisplaySize();
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
          };

          requestAnimationFrame(animate);
        });
      }
    }

		customElements.define('x-model', Model);
	</script>
</body>

</html>